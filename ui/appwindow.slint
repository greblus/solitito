import { Button, Slider, CheckBox, VerticalBox, HorizontalBox, GridBox, ScrollView, ComboBox, LineEdit } from "std-widgets.slint";

component NoteBar inherits Rectangle {
    in property <string> label;
    in property <brush> bar_color;
    width: 55px;
    height: 60px;
    background: transparent;

    VerticalLayout {
        alignment: center;
        Text {
            text: root.label;
            font-size: 32px;
            color: root.bar_color;
            horizontal-alignment: center;
        }
    }
}

component DebugBar inherits Rectangle {
    in property <float> level;
    in property <bool> is_octave;
    width: 6px;
    height: 60px;
    background: #111;
    
    Rectangle {
        y: parent.height - self.height;
        height: parent.height * level;
        background: is_octave ? #ffee00 : #0077ff;
        width: 100%;
    }
}

export component AppWindow inherits Window {
    title: "Solitito 2.0";
    width: 400px;
    height: 650px; // Trochę więcej miejsca na settings
    background: #000000;

    // --- DANE ---
    in property <string> song_title: "Giant Steps";
    in property <string> chord_name: "B Maj7";
    in property <string> ai_text: "AI: ...";
    in property <string> next_chord: "D7";
    
    in property <[string]> interval_names;
    in property <[color]> interval_colors;
    in property <[float]> spectrum_data;
    
    // Lista utworów/skal do ComboBoxa
    in property <[string]> library_items;
    in-out property <int> current_item_index: 0;

    // --- USTAWIENIA ---
    in-out property <bool> show_settings: false;
    
    in-out property <float> threshold: 0.15;
    in-out property <float> tail: 0.3;
    in-out property <float> delay: 0.6;
    in-out property <bool> boost_enabled: true;
    in-out property <float> boost_gain: 5.0;
    in-out property <bool> random_enabled: false;
    in-out property <string> interval_input_text: "1 3 5";
    
    // Callbacks
    callback toggle_mode(int); // 0=Songs, 1=Scales
    callback item_selected(int); // Wybrano z listy

    VerticalLayout {
        padding: 10px;
        spacing: 10px;

        // GÓRA
        HorizontalLayout {
            alignment: end;
            Button {
                text: root.show_settings ? "Close" : "⚙ Settings";
                height: 32px; 
                clicked => { root.show_settings = !root.show_settings; }
            }
        }

        // PANEL USTAWIEŃ
        if root.show_settings : Rectangle {
            background: #222;
            border-radius: 10px;
            
            VerticalLayout {
                padding: 10px; 
                spacing: 12px;
                
                Text { 
                    text: "Settings"; 
                    font-size: 18px; 
                    color: white; 
                    horizontal-alignment: center; 
                }
                
                HorizontalLayout {
                    spacing: 10px;
                    Button { text: "Songs"; clicked => { root.toggle_mode(0); } }
                    Button { text: "Scales"; clicked => { root.toggle_mode(1); } }
                }

                // NOWOŚĆ: Lista wyboru
                HorizontalLayout {
                    Text { text: "Select: "; color: white; vertical-alignment: center; width: 60px; }
                    ComboBox {
                        model: root.library_items;
                        current-index <=> root.current_item_index;
                        selected => { root.item_selected(self.current-index); }
                    }
                }

                HorizontalLayout {
                    Text { text: "Thresh: "; color: white; vertical-alignment: center; width: 60px; }
                    Slider { minimum: 0.0; maximum: 2.0; value <=> root.threshold; }
                }
                
                HorizontalLayout {
                    Text { text: "Tail: "; color: white; vertical-alignment: center; width: 60px; }
                    Slider { minimum: 0.1; maximum: 0.9; value <=> root.tail; }
                }

                HorizontalLayout {
                    Text { text: "Delay: "; color: white; vertical-alignment: center; width: 60px; }
                    Slider { minimum: 0.0; maximum: 2.0; value <=> root.delay; }
                }

                // FIX KOLORÓW CHECKBOXÓW (Ręczny tekst)
                HorizontalLayout {
                    spacing: 10px;
                    HorizontalLayout {
                        CheckBox { checked <=> root.boost_enabled; }
                        Text { text: "Bass Boost"; color: white; vertical-alignment: center; }
                    }
                    if root.boost_enabled : Slider { 
                        minimum: 1.0; maximum: 20.0; value <=> root.boost_gain; 
                    }
                }
                
                HorizontalLayout {
                    CheckBox { checked <=> root.random_enabled; }
                    Text { text: "Random Trainer"; color: white; vertical-alignment: center; }
                }

                HorizontalLayout {
                    Text { text: "Intervals: "; color: white; vertical-alignment: center; }
                    LineEdit {
                        text <=> root.interval_input_text;
                        placeholder-text: "e.g. 1 3 5 7";
                    }
                }

                // Debugger
                Rectangle {
                    height: 60px;
                    background: black;
                    HorizontalLayout {
                        spacing: 1px;
                        for val[i] in root.spectrum_data : DebugBar {
                            level: val;
                            is_octave: mod(i + 4, 12) == 0; 
                        }
                    }
                }
            }
        }

        // GŁÓWNY WIDOK
        VerticalLayout {
            alignment: center;
            spacing: 30px;
            
            Text {
                text: root.song_title;
                font-size: 24px;
                color: #aaa;
                horizontal-alignment: center;
                wrap: word-wrap;
            }

            Text {
                text: root.chord_name;
                font-size: 70px;
                font-weight: 800;
                color: white;
                horizontal-alignment: center;
            }
            
            Text {
                text: root.ai_text;
                font-size: 40px;
                color: #ffee00; 
                horizontal-alignment: center;
            }
            
            HorizontalLayout {
                alignment: center;
                spacing: 5px;
                for i in root.interval_names.length : NoteBar {
                    label: root.interval_names[i];
                    bar_color: root.interval_colors[i];
                }
            }
        }
        
        // STOPKA
        Rectangle {
            height: 60px;
            VerticalLayout {
                alignment: center;
                Text { 
                    text: "Next: " + root.next_chord; 
                    color: #666; 
                    horizontal-alignment: center; 
                    font-size: 24px; 
                }
            }
        }
    }
}
